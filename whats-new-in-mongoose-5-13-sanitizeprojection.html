<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TE4SWRGR9E"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-TE4SWRGR9E');
</script><title>What's New in Mongoose 5.13: The sanitizeProjection Option | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="What's New in Mongoose 5.13: The sanitizeProjection Option"><meta property="og:url" content="http://www.thecodebarbarian.com/whats-new-in-mongoose-5-13-sanitizeprojection"><meta property="og:image" content="https://codebarbarian-images.s3.amazonaws.com/georgia.jpeg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="Mongoose 5.13.0 introduces a new `sanitizeProjection` option that helps protect you from potentially untrusted query projections leaking sensitive data. Here's what you need to know."><meta name="twitter:image" content="https://codebarbarian-images.s3.amazonaws.com/georgia.jpeg"><meta name="twitter:card" content="summary_large_image"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">What's New in Mongoose 5.13: The sanitizeProjection Option</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">August 12, 2021</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://github.com/Automattic/mongoose/blob/master/History.md#5110--2020-11-30">Mongoose 5.13.0 was released on June 26, 2021</a> and includes 17 new features, including 5 community contributions.
Mongoose 5.13 includes several noteworthy features - in this article I&#39;ll cover the <code>sanitizeProjection</code> option, which addresses a new potential security issue in MongoDB 4.4.</p>
<h2 id="projections-in-mongodb-44">Projections in MongoDB 4.4</h2>
<p>One of the major internal achievements in MongoDB 4.4 was unifying queries and aggregations.
As of MongoDB 4.4, the MongoDB server now handles <code>find(filter)</code> as a <code>aggregate([{ $match: filter }])</code> under the hood.
However, this has a somewhat surprising consequence: MongoDB 4.4 treats <code>filter(filter).select(fields)</code> as <code>aggregate([{ $match: filter }, { $project: fields }])</code>, <em>including</em> the <code>$project</code> stage&#39;s support for aliases.</p>
<p>In other words, if you rely on Mongoose&#39;s <code>select</code> to hide certain fields, a malicious user may be able to access hidden fields if you allow user-specified query projections.
For example, suppose you use <code>select</code> to hide a <code>password</code> field.
The below query will replace the value of the user&#39;s <code>name</code> property with the value of the <code>password</code> property, even though <code>password</code> is excluded by default.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> Schema({
  name: <span class="hljs-built_in">String</span>,
  password: { type: <span class="hljs-built_in">String</span>, select: <span class="hljs-literal">false</span> }
});
<span class="hljs-keyword">const</span> UserModel = mongoose.model(<span class="hljs-string">'User'</span>, schema);

<span class="hljs-keyword">const</span> { _id } = <span class="hljs-keyword">await</span> UserModel.create({
  name: <span class="hljs-string">'my name'</span>,
  password: <span class="hljs-string">'my secret'</span>
});

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> UserModel.findById(_id).select({ name: <span class="hljs-string">'$password'</span> });
user.name; <span class="hljs-comment">// 'my secret' even though `password` is deselected!</span></code></pre>
<p>For many apps, this isn&#39;t a problem.
However, this new behavior may be a problem if your app allows user-specified projections.
For example, the below Express endpoint is vulnerable because a malicious user can make an HTTP request with the query string <code>?name=$password</code> to get the user&#39;s password hash.</p>
<pre><code class="language-javascript">app.get(<span class="hljs-string">'/user/:id'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  UserModel.findById(id).select(req.query.filter).then(
    doc =&gt; res.json(doc),
    err =&gt; res.status(<span class="hljs-number">500</span>).json({ message: err.message })
  )
});</code></pre>
<h2 id="the-sanitizeprojection-option">The <code>sanitizeProjection</code> Option</h2>
<p>Mongoose 5.13 includes a <code>sanitizeProjection</code> option that lets you opt in to Mongoose replacing any strings in projections with the number <code>1</code>.
This means there&#39;s no way to access a non-selected field from a query projection, so you can use user-specified data for projections without any manual validation.</p>
<pre><code class="language-javascript">mongoose.set(<span class="hljs-string">'sanitizeProjection'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> Schema({
  name: <span class="hljs-built_in">String</span>,
  password: { type: <span class="hljs-built_in">String</span>, select: <span class="hljs-literal">false</span> }
});
<span class="hljs-keyword">const</span> UserModel = mongoose.model(<span class="hljs-string">'User'</span>, schema);

<span class="hljs-keyword">const</span> { _id } = <span class="hljs-keyword">await</span> UserModel.create({
  name: <span class="hljs-string">'my name'</span>,
  password: <span class="hljs-string">'my secret'</span>
});

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> UserModel.findById(_id).select({ name: <span class="hljs-string">'$password'</span> });
user.name; <span class="hljs-comment">// 'my name'</span></code></pre>
<p>Like many other Mongoose options, you can configure <code>sanitizeProjection</code> globally, or on an individual query.
<code>sanitizeProjection</code> is disabled by default, but you can enable it for a single query as shown below.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> UserModel.findById(_id).select(projection).setOptions({
  sanitizeProjection: <span class="hljs-literal">true</span>
});</code></pre>
<h2 id="moving-on">Moving On</h2>
<p>MongoDB 4.4 made major changes in how MongoDB handles query projections.
Before MongoDB 4.4, using user-specified projections in queries was safe because projections were highly limited.
As of MongoDB 4.4, projections can pull in other fields, including ones that are explicitly excluded.
The <code>sanitizeProjection</code> option can make your app more secure 
Custom casting is just one of 17 new features in Mongoose 5.13. Make sure you upgrade to take advantage of optimistic concurrency and all the other new features!</p>
<p><em>Want to become your team&#39;s MongoDB expert? &quot;Mastering Mongoose&quot; distills 8 years of hard-earned lessons building Mongoose apps at scale into 153 pages. That means you can learn what you need to know to build production-ready full-stack apps with Node.js and MongoDB in a few days. <a href="https://masteringjs.io/ebooks/mastering-mongoose">Get your copy</a>!</em></p>
<a href="https://masteringjs.io/ebooks/mastering-mongoose" class="async-await-banner">
  <img src="https://masteringjs.io/ebooks/mastering-mongoose-horizontal.png">
</a></div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>