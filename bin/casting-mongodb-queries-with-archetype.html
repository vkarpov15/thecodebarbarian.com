<html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Casting MongoDB Queries with Archetype | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"/><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/><link href="/style/style.css" rel="stylesheet" type="text/css"/><link href="/style/github.css" rel="stylesheet" type="text/css"/><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Casting MongoDB Queries with Archetype"/><meta property="og:url" content="http://www.thecodebarbarian.com/casting-mongodb-queries-with-archetype"/><meta property="og:image" content="http://i.imgur.com/g4xbjym.png"/><meta property="og:site_name" content="The Code Barbarian"/></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li></ul></div></div><div id="nav" class="navbar"><div class="container"><div class="navbar-header"><a href="http://thecodebarbarian.com" class="navbar-brand big-brand"><img src="/images/Barbarian_Head.png" class="logo"/><span class="site-name">The Code Barbarian</span></a></div><div id="home-nav-mobile" class="navbar-right collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/angularjs.html">AngularJS</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div id="desktop-right-bar" class="col-lg-3 col-lg-offset-9 right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net"><img src="http://asyncawait.net/images/cover_400.png"/><p><i>Mastering Async/Await</i></p></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"/><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div><div><script type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=thecodebarbariancom" id="_carbonads_js"></script></div></p></div></div></div></div></div><div id="mobile-sharing-options" class="container-fluid hidden-sm hidden-md hidden-lg"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Fcasting-mongodb-queries-with-archetype&amp;via=code_barbarian" class="social"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fcasting-mongodb-queries-with-archetype" class="social"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fcasting-mongodb-queries-with-archetype" class="social"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a href="#disqus_thread" class="social"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div id="desktop-sharing-options" class="post-sharing-options hidden-xs pull-left"><ul class="list-unstyled"><li class="twitter-share"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Fcasting-mongodb-queries-with-archetype&amp;via=code_barbarian" class="social"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fcasting-mongodb-queries-with-archetype" class="social"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fcasting-mongodb-queries-with-archetype" class="social"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Casting MongoDB Queries with Archetype</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">January 04, 2017</span></div></div></div><div><script>
  _native.init("CK7DT53U",{
    targetClass: 'native-inline'
  });
</script>

<div class="native-inline">
  <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# â€” #native_desc#</a>
</div>
</div><div class="post-body-text-container"><p>One of <a href="https://www.npmjs.com/package/archetype-js">Archetype&#39;s</a> core design goals
was to support type casting for MongoDB queries. <a href="http://mongodb.github.io/node-mongodb-native/2.2/api/ObjectID.html">MongoDB ObjectIds are objects</a>
but they&#39;re usually sent over the wire as strings in JSON. In order to
use the string in a query, you need to convert it into an ObjectId.</p>
<pre><code class="lang-javascript">id = <span class="hljs-keyword">new</span> mongodb.ObjectId(id);
</code></pre>
<p>This works fine if you have one id. The MongoDB driver will create a new
ObjectId and throw an error if it failed? But then what if you have multiple
ObjectIds? What if you have ObjectIds that are nested in arrays? What if you
want to support <a href="https://docs.mongodb.com/manual/reference/operator/query/">MongoDB query operators</a>?</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// How to convert all these into ObjectIds? "Flip the table" or</span>
<span class="hljs-comment">// "long wall of if statements and for loops" are not valid options.</span>
<span class="hljs-keyword">const</span> data1 = {
  id: <span class="hljs-string">'586d5208616a940f835dac51'</span>,
  ids: [<span class="hljs-string">'586d5208616a940f835dac51'</span>, <span class="hljs-string">'586d521e616a940f835dac52'</span>],
  nested: {
    id: <span class="hljs-string">'586d5208616a940f835dac51'</span>
  }
}

<span class="hljs-keyword">const</span> data2 = {
  id: {
    $<span class="hljs-keyword">in</span>: [<span class="hljs-string">'586d5208616a940f835dac51'</span>, <span class="hljs-string">'586d521e616a940f835dac52'</span>]
  }
}
</code></pre>
<p>Archetype makes this easy: you just define 2 types, and archetype handles
all the hard recursion for you.</p>
<h2 id="casting-to-objectids-in-archetype">Casting to ObjectIds in Archetype</h2>
<p>Casting raw data into an ObjectId in Archetype is easy:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> Archetype = <span class="hljs-built_in">require</span>(<span class="hljs-string">'archetype-js'</span>);
<span class="hljs-keyword">const</span> {ObjectId} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);

<span class="hljs-keyword">const</span> Type = <span class="hljs-keyword">new</span> Archetype({
  id: { $type: ObjectId }, <span class="hljs-comment">// $type can be any constructor</span>
  ids: [ObjectId], <span class="hljs-comment">// Can also use arrays</span>
  nested: {
    id: { $type: ObjectId } <span class="hljs-comment">// Archetype supports nested props</span>
  }
}).compile(<span class="hljs-string">'Type'</span>);

<span class="hljs-keyword">const</span> v = <span class="hljs-keyword">new</span> Type({
  id: <span class="hljs-string">'586d5208616a940f835dac51'</span>,
  ids: [<span class="hljs-string">'586d5208616a940f835dac51'</span>, <span class="hljs-string">'586d521e616a940f835dac52'</span>],
  nested: {
    id: <span class="hljs-string">'586d5208616a940f835dac51'</span>
  }
});

<span class="hljs-built_in">console</span>.log(v.id.constructor.name); <span class="hljs-comment">// ObjectID</span>
<span class="hljs-built_in">console</span>.log(v.ids[<span class="hljs-number">0</span>].constructor.name); <span class="hljs-comment">// ObjectID</span>
<span class="hljs-built_in">console</span>.log(v.nested.id.constructor.name); <span class="hljs-comment">// ObjectID</span>
</code></pre>
<p>The <code>new Type()</code> call will throw an exception if any of the ObjectIds are
invalid. This demonstrates the fundamental goal of Archetype: it&#39;s a framework
for composing types from other types. A single ObjectId is easy to understand,
Archetype lets you create complex types whose properties can be ObjectIds or
other types so you can handle complex objects as easily as you handle a single
ObjectId.</p>
<h2 id="casting-query-operators">Casting Query Operators</h2>
<p>Archetype is not limited to just MongoDB ObjectIds. Any archetype is a valid
<code>$type</code> for another archetype. Let&#39;s see this in action for casting MongoDB
query operators.</p>
<p>Suppose you have the following MongoDB document:</p>
<pre><code class="lang-javascript">{
  id: ObjectId(<span class="hljs-string">'586d5208616a940f835dac51'</span>),
  nested: {
    id: ObjectId(<span class="hljs-string">'586d5208616a940f835dac51'</span>)
  }
}
</code></pre>
<p>We want Archetype to make it so the following queries will match the above document:</p>
<pre><code class="lang-javascript">{ id: <span class="hljs-string">'586d5208616a940f835dac51'</span> }
{ id: { $eq: <span class="hljs-string">'586d5208616a940f835dac51'</span> } }
{ id: { $<span class="hljs-keyword">in</span>: [<span class="hljs-string">'586d5208616a940f835dac51'</span>] } }
{ <span class="hljs-string">'nested.id'</span>: <span class="hljs-string">'586d5208616a940f835dac51'</span> }
{ <span class="hljs-string">'nested.id'</span>: { $eq: <span class="hljs-string">'586d5208616a940f835dac51'</span> } }
{ <span class="hljs-string">'nested.id'</span>: { $<span class="hljs-keyword">in</span>: [<span class="hljs-string">'586d5208616a940f835dac51'</span>] } }
</code></pre>
<p>First, let&#39;s solve an easier problem: how do you coerce <code>{ $eq: &#39;586d5208616a940f835dac51&#39; }</code> and <code>{ $in: [&#39;586d5208616a940f835dac51&#39;] }</code> into ObjectIds? Here&#39;s an Archetype for that:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> QueryId = <span class="hljs-keyword">new</span> Archetype({
  $eq: ObjectId,
  $<span class="hljs-keyword">in</span>: [ObjectId]
  <span class="hljs-comment">// Can add other MongoDB query operators as well - $gte, $lte, $nin, etc.</span>
}).compile(<span class="hljs-string">'QueryId'</span>);
</code></pre>
<p>How about coercing <code>&#39;586d5208616a940f835dac51&#39;</code>? Archetypes are just <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes">JavaScript classes</a>,
so you can build on top of them using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/extends">the <code>extends</code> keyword</a>:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> QueryIdBase = <span class="hljs-keyword">new</span> Archetype({
  $eq: ObjectId,
  $<span class="hljs-keyword">in</span>: [ObjectId]
}).compile(<span class="hljs-string">'QueryId'</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueryId</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">QueryIdBase</span> </span>{
  <span class="hljs-keyword">constructor</span>(v) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">super</span>(v);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">super</span>({ $eq: v });
    }
  }
}

<span class="hljs-comment">// ObjectId</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> QueryId(<span class="hljs-string">'586d5208616a940f835dac51'</span>).$eq.constructor.name);
</code></pre>
<p>Now that you&#39;ve solved the core problem, you can use Archetype to compose
this <code>QueryId</code> type to solve the original problem.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> Query = <span class="hljs-keyword">new</span> Archetype({
  id: QueryId,
  <span class="hljs-string">'nested.id'</span>: QueryId
}).compile(<span class="hljs-string">'Query'</span>);
</code></pre>
<p>Now <code>Query</code> is a type you can use to coerce all your query properties into
ObjectIds correctly. Don&#39;t believe me? Here&#39;s a test.</p>
<pre><code class="lang-javascript">[
  { id: <span class="hljs-string">'586d5208616a940f835dac51'</span> },
  { id: { $eq: <span class="hljs-string">'586d5208616a940f835dac51'</span> } },
  { id: { $<span class="hljs-keyword">in</span>: [<span class="hljs-string">'586d5208616a940f835dac51'</span>] } },
  { <span class="hljs-string">'nested.id'</span>: <span class="hljs-string">'586d5208616a940f835dac51'</span> },
  { <span class="hljs-string">'nested.id'</span>: { $eq: <span class="hljs-string">'586d5208616a940f835dac51'</span> } },
  { <span class="hljs-string">'nested.id'</span>: { $<span class="hljs-keyword">in</span>: [<span class="hljs-string">'586d5208616a940f835dac51'</span>] } },
].map(v =&gt; <span class="hljs-keyword">new</span> Query(v)).forEach(v =&gt; check(v))

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params">v</span>) </span>{
  v = firstValue(firstValue(v));
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(v)) {
    v = v[<span class="hljs-number">0</span>];
  }
  assert.equal(v.constructor.name, <span class="hljs-string">'ObjectID'</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">firstValue</span>(<span class="hljs-params">v</span>) </span>{
  <span class="hljs-keyword">return</span> v[<span class="hljs-built_in">Object</span>.keys(v)[<span class="hljs-number">0</span>]];
}
</code></pre>
<p>You can even create a function that generates a <code>QueryField</code> archetype for
any type:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> QueryField = type =&gt; {
  <span class="hljs-keyword">const</span> QueryFieldBase = <span class="hljs-keyword">new</span> Archetype({
    $eq: type,
    $<span class="hljs-keyword">in</span>: [type]
  }).compile(<span class="hljs-string">'QueryField'</span>);

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueryField</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">QueryFieldBase</span> </span>{
    <span class="hljs-keyword">constructor</span>(v) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'object'</span>) {
        <span class="hljs-keyword">super</span>(v);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">super</span>({ $eq: v });
      }
    }
  }

  <span class="hljs-keyword">return</span> QueryField;
}

<span class="hljs-keyword">const</span> Query = <span class="hljs-keyword">new</span> Archetype({
  id: QueryField(ObjectId),
  <span class="hljs-string">'nested.id'</span>: QueryField(ObjectId)
}).compile(<span class="hljs-string">'Query'</span>);
</code></pre>
<p><img src="http://i.imgur.com/tr8ssaK.png" /></p>
<h2 id="conclusion">Conclusion</h2>
<p>Archetype is all about composing types in an elegant and intuitive way. You can
compose archetypes using nesting, extend archetypes using <code>extends</code>, and abstract out archetypes behind functions. Using these principles, you can build types in ways that
joi, JSON schema, and even <a href="https://www.npmjs.com/package/mongoose">mongoose</a> simply cannot do, and minimize the amount of time you waste debugging runtime type issues.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/20170104_archetype_query.md">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
  analytics.load("5DErrxzVhprg8sNh8xaiKDR6dNa7yGTI");
  analytics.page()
}}();</script><script type="text/javascript">analytics.track('opened post',
  { title: "Casting MongoDB Queries with Archetype", time: new Date() });
  </script><script type="text/javascript" src="/js/native.js"></script><link rel="stylesheet" href="/style/inlinecpc.css"/></body></html>