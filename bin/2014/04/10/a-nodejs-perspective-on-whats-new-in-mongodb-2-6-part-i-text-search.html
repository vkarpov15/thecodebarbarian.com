<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>A NodeJS Perspective on What's New in MongoDB 2.6, Part I: Text Search | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="A NodeJS Perspective on What's New in MongoDB 2.6, Part I: Text Search"><meta property="og:url" content="http://www.thecodebarbarian.com/2014/04/10/a-nodejs-perspective-on-whats-new-in-mongodb-2-6-part-i-text-search"><meta property="og:image" content="//samuellam.files.wordpress.com/2012/09/nodemongo.png"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="MongoDB shipped the newest stable version of its server, 2.6.0, this week. This new release is massive: there were about [4000 commits](https://github.com/mongodb/mongo/branches) between 2.4 and 2.6. Unsurprisingly, the [release notes](http://docs.mongodb.org/manual/release-notes/2.6/) are a pretty dense read and don't quite convey how cool some of these new features are. To remedy that, I'll dedicate a couple posts to putting on my NodeJS web developer hat and exploring interesting use cases for new features in 2.6. The first feature I'll dig in to is text search, or, in layman's terms, Google for your MongoDB documents."></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div><div><script type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=thecodebarbariancom" id="_carbonads_js"></script></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">A NodeJS Perspective on What's New in MongoDB 2.6, Part I: Text Search</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">April 10, 2014</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script>
  _native.init("CK7DT53N",{
    targetClass: 'native-inline'
  });
</script>

<div class="native-inline">
  <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# - #native_desc#</a>
</div>
</div><div class="post-body-text-container"><p>MongoDB shipped the newest stable version of its server, 2.6.0, this week. This new release is massive: there were about <a href="https://github.com/mongodb/mongo/branches">4000 commits</a> between 2.4 and 2.6. Unsurprisingly, the <a href="http://docs.mongodb.org/manual/release-notes/2.6/">release notes</a> are a pretty dense read and don&#39;t quite convey how cool some of these new features are. To remedy that, I&#39;ll dedicate a couple posts to putting on my NodeJS web developer hat and exploring interesting use cases for new features in 2.6. The first feature I&#39;ll dig in to is text search, or, in layman&#39;s terms, Google for your MongoDB documents.</p>
<p>Text search was technically in 2.4, but it was an experimental feature and not part of the query framework. Now, in 2.6, text is a full-fledged query operator, enabling you search for documents by text in <a href="http://docs.mongodb.org/manual/reference/text-search-languages/#text-search-languages">15 different languages</a>.</p>
<h2 id="getting-started-with-text-search">Getting Started With Text Search</h2>
<p>Let&#39;s dive right in and use text search on the USDA SR-25 data set described in <a href="http://thecodebarbarian.com/2014/03/28/plugging-usda-nutrition-data-into-mongodb/">this post</a>. You can download a mongorestore-friendly version of the data set here. The data set contains 8194 food items with associated nutrition data, and each food item has a human-readable description, e.g. &quot;Kale, raw&quot; or &quot;Bison, ground, grass-fed, cooked&quot;. Ideally, as a client of this data set, we shouldn&#39;t have to remember whether we need to enter &quot;Bison, grass-fed, ground, cooked&quot; or &quot;Bison, ground, grass-fed, cooked&quot; to get the data we&#39;re looking for. We should just be able to put in &quot;grass-fed bison&quot; and get reasonable results.</p>
<p>Thankfully, text search makes this simple. In order to do text search, first we need to <a href="http://docs.mongodb.org/manual/core/index-text/#create-text-index">create a text index</a> on your copy of the USDA nutrition collection. Lets create one on the food item&#39;s description:</p>
<pre><code>db.nutrition.ensureIndex({ description : &quot;text&quot; });</code></pre><p>Now, we can search the data set for our &quot;raw kale&quot; and &quot;grass-fed bison&quot;, and see what we get:</p>
<pre><code>db.nutrition.find(
  { $text : { $search : &quot;grass-fed bison&quot; } },
  { description : 1 }).
    limit(3);

db.nutrition.find(
  { $text : { $search : &quot;raw kale&quot; } },
  { description : 1 }).
    limit(3);</code></pre><p><a href="http://i.imgur.com/JSDNeam.png"><img src="//i.imgur.com/JSDNeam.png" style="width: 100%"></a></p>
<p>Unfortunately, the results we got aren&#39;t that useful, because they&#39;re not in order of relevance. Unless we explicitly tell MongoDB to sort by the text score, we probably won&#39;t get the most relevant documents first. Thankfully, with the help of the new <a href="http://docs.mongodb.org/master/reference/operator/projection/meta/#proj._S_meta"><code>$meta</code> keyword</a> (which is currently only useful for getting the text score), we can tell MongoDB to sort by text score <a href="http://docs.mongodb.org/master/reference/operator/query/text/#ex-sort-text-search-score">as described here</a>:</p>
<pre><code>db.nutrition.find(
  { $text : { $search : &quot;raw kale&quot; } },
  { description : 1, textScore : { $meta : &quot;textScore&quot; } }).
    sort({ textScore : { $meta : &quot;textScore&quot; } }).
    limit(3);</code></pre><p><a href="http://i.imgur.com/q6Xh433.png"><img src="//i.imgur.com/q6Xh433.png" style="width: 100%"></a></p>
<h2 id="using-text-search-in-nodejs">Using Text Search in NodeJS</h2>
<p>First, an important note on the compatibility of text search with NodeJS community projects: the <a href="https://github.com/mongodb/node-mongodb-native">MongoDB NodeJS driver</a> is compatible with text search going back to at least 1.3.0. However, only the latest version of <a href="https://github.com/aheckmann/mquery">mquery</a>, 0.6.0, is compatible with text search. By extension, the popular ODM <a href="https://github.com/LearnBoost/mongoose">Mongoose</a>, which relies on mquery, unfortunately doesn&#39;t have a text search compatible release at the time of this blog post. I pushed a <a href="https://github.com/LearnBoost/mongoose/commit/22602aef2af6cc0b7eddb1ac4fbe73fcd05384e5">commit to fix this</a> and the next version of Mongoose, 3.8.9, should allow you to sort by text score. In summary, to use MongoDB text search, here are the version restrictions:</p>
<ul>
<li><a href="https://github.com/mongodb/node-mongodb-native">MongoDB NodeJS driver</a>: &gt;= 1.4.0 is recommended, but it seems to work going back to at least 1.2.0 in my personal experiments.</li>
<li><a href="https://github.com/aheckmann/mquery">mquery</a>: &gt;= 0.6.0</li>
<li><a href="https://github.com/LearnBoost/mongoose">Mongoose</a>: &gt;= 3.8.9</li>
</ul>
<p>Now that you know which versions are supported, let&#39;s demonstrate how to actually do text search with the NodeJS driver. I created a simple food journal (e.g. an app that counts calories for you when you enter in how much of a certain food you&#39;ve eaten) app that is meant to tie in to the SR-25 data set. This app is available on GitHub <a href="https://github.com/vkarpov15/lean-mean-nutrition-sample">here</a>, so feel free to play with it.</p>
<p>The LeanMEAN app exposes an API endpoint, <code>GET /api/food/search/:search</code>, that runs text search on a local copy of the SR-25 data set. The implementation of this endpoint is here. For convenience, here is the actual implementation, where the <code>FoodItem</code> variable is the Mongoose model for the SR-25 collection.</p>
<pre><code>/* Mongoose &gt;= 3.8.9 supports text search */
exports.searchFood = function(FoodItem) {
  return function(req, res) {
    var search = req.params.search;

    FoodItem.
      find(
        { $text : { $search : search } },
        { score : { $meta: &quot;textScore&quot; } }
      ).
      sort({ score: { $meta : &quot;textScore&quot; } }).
      limit(10).
      exec(function(error, foodItems) {
        if (error) {
          res.json(500, { error : error });
        } else {
          res.json(foodItems);
        }
      });
  }
};</code></pre><p>Unsurprisingly, this code looks pretty similar to the shell version, so it shouldn&#39;t look unfamiliar to you NodeJS pros :)</p>
<h2 id="looking-forward">Looking Forward</h2>
<p>And that&#39;s all on text search for now. In the next post (scheduled for 4/25), we&#39;ll tackle some of the awesome new features in the aggregation framework, including text search in aggregation.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>