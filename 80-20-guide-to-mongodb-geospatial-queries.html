<html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>The 80/20 Guide to MongoDB Geospatial Queries | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"/><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/><link href="/style/style.css" rel="stylesheet" type="text/css"/><link href="/style/github.css" rel="stylesheet" type="text/css"/><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="The 80/20 Guide to MongoDB Geospatial Queries"/><meta property="og:url" content="http://www.thecodebarbarian.com/80-20-guide-to-mongodb-geospatial-queries"/><meta property="og:image" content="http://i.imgur.com/oEshByg.png"/><meta property="og:site_name" content="The Code Barbarian"/></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"/><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"/></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"/><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div><div><script type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=thecodebarbariancom" id="_carbonads_js"></script></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">The 80/20 Guide to MongoDB Geospatial Queries</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">October 14, 2016</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script>
  _native.init("CK7DT53N",{
    targetClass: 'native-inline'
  });
</script>

<div class="native-inline">
  <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# - #native_desc#</a>
</div>
</div><div class="post-body-text-container"><p>MongoDB&#39;s powerful built-in geospatial queries are one of the big reasons
why I made it my database of choice. After the old days of struggling with
PostGIS or the really old days of implementing the Haversine formula myself
in MySQL, having <a href="https://docs.mongodb.com/manual/applications/geospatial-indexes/">geospatial operators and indexes built-in</a> was
a breath of fresh air. However, the MongoDB geospatial querying docs often miss
the forest for the trees. In this article, I&#39;ll focus specifically on <a href="http://geojson.org/">GeoJSON</a> queries in the MongoDB shell and how to implement
several common geospatial queries in MongoDB.</p>
<h2 id="which-documents-are-in-a-given-polygon">Which documents are in a given polygon?</h2>
<p>The simplest geospatial operator is <a href="https://docs.mongodb.com/manual/reference/operator/query/geoIntersects/"><code>$geoIntersects</code></a>. Given a <a href="/a-practical-introduction-to-geojson-with-node-js.html#polygons">GeoJSON polygon</a>, <code>$geoIntersects</code> will give you all
documents whose GeoJSON geometries intersect with the polygon. Suppose you have
a list of ski resorts in a <code>locations</code> collection:</p>
<pre><code>&gt; db.locations.find().pretty()
{
    <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"5801594c4067070bfcb01293"</span>),
    <span class="hljs-string">"name"</span> : <span class="hljs-string">"Squaw Valley"</span>,
    <span class="hljs-string">"location"</span> : {
        <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>,
        <span class="hljs-string">"coordinates"</span> : [
            <span class="hljs-number">-120.24</span>,
            <span class="hljs-number">39.21</span>
        ]
    }
}
{
    <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159634067070bfcb01294"</span>),
    <span class="hljs-string">"name"</span> : <span class="hljs-string">"Mammoth Lakes"</span>,
    <span class="hljs-string">"location"</span> : {
        <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>,
        <span class="hljs-string">"coordinates"</span> : [
            <span class="hljs-number">-118.9</span>,
            <span class="hljs-number">37.61</span>
        ]
    }
}
{
    <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159d94067070bfcb01295"</span>),
    <span class="hljs-string">"name"</span> : <span class="hljs-string">"Aspen"</span>,
    <span class="hljs-string">"location"</span> : {
        <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>,
        <span class="hljs-string">"coordinates"</span> : [
            <span class="hljs-number">-106.82</span>,
            <span class="hljs-number">39.18</span>
        ]
    }
}
{
    <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"58015a704067070bfcb01296"</span>),
    <span class="hljs-string">"name"</span> : <span class="hljs-string">"Whistler"</span>,
    <span class="hljs-string">"location"</span> : {
        <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>,
        <span class="hljs-string">"coordinates"</span> : [
            <span class="hljs-number">-122.95</span>,
            <span class="hljs-number">50.12</span>
        ]
    }
}</code></pre><p>How many of these locations are in the state of Colorado? Let&#39;s approximate
Colorado as the below GeoJSON square.</p>
<pre><code>{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"Polygon"</span>,
  <span class="hljs-string">"coordinates"</span>: [[
    [<span class="hljs-number">-109</span>, <span class="hljs-number">41</span>],
    [<span class="hljs-number">-102</span>, <span class="hljs-number">41</span>],
    [<span class="hljs-number">-102</span>, <span class="hljs-number">37</span>],
    [<span class="hljs-number">-109</span>, <span class="hljs-number">37</span>],
    [<span class="hljs-number">-109</span>, <span class="hljs-number">41</span>]
  ]]
}</code></pre><p>Here&#39;s how these geometries look on a map. Click on the map for an interactive
view.</p>
<a href="http://bl.ocks.org/anonymous/raw/a297439e02cad4ae5c41ed9e1d89b344/">
<img src="http://i.imgur.com/59OCqJR.jpg" />
</a>

<p>Here&#39;s what this query looks like in the MongoDB shell:</p>
<pre><code>&gt; db.locations.find({
...   location: {
...     $geoIntersects: {
...       $geometry: {
...         type: <span class="hljs-string">"Polygon"</span>,
...         coordinates: [[
...           [<span class="hljs-number">-109</span>, <span class="hljs-number">41</span>],
...           [<span class="hljs-number">-102</span>, <span class="hljs-number">41</span>],
...           [<span class="hljs-number">-102</span>, <span class="hljs-number">37</span>],
...           [<span class="hljs-number">-109</span>, <span class="hljs-number">37</span>],
...           [<span class="hljs-number">-109</span>, <span class="hljs-number">41</span>]
...         ]]
...       }
...     }
...   }
... })
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159d94067070bfcb01295"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Aspen"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-106.82</span>, <span class="hljs-number">39.18</span> ] } }
&gt;</code></pre><p>As expected, MongoDB managed to figure out that Aspen is in Colorado, and
Squaw Valley, Mammoth Lakes, and Whistler are not. This query is not terribly
enlightening, but if you start importing data like <a href="https://github.com/jgoodall/us-maps">US zip codes and counties</a> MongoDB can start looking like
your own personal <a href="https://developers.google.com/maps/faq#usage-limits">non-rate-limited geocoder</a>.</p>
<p>The <code>$geometry</code> property under <code>$geoIntersects</code> is required for the
<code>$geoIntersects</code> operator, but not for the other geospatial operators you&#39;ll
learn about later. For now, just think of it as boilerplate.</p>
<h2 id="which-documents-are-within-a-certain-distance-of-a-given-point">Which documents are within a certain distance of a given point?</h2>
<p>One big GeoJSON limitation is that it <a href="http://stackoverflow.com/questions/16942697/geojson-circles-supported-or-not">can&#39;t represent circles</a>. That&#39;s a problem if you want to, say, find all ski resorts within 300
miles of San Francisco and avoid having to fly. The <code>$geoIntersects</code> operator
won&#39;t help you here, but the <a href="https://docs.mongodb.com/manual/reference/operator/query/geoWithin/"><code>$geoWithin</code> operator</a> will.</p>
<p>The <code>$geoWithin</code> operator is similar to <code>$geoIntersects</code>. You can replace
<code>$geoIntersects</code> with <code>$geoWithin</code> in the &quot;find documents in Colorado&quot; query
and get the same result.</p>
<pre><code>&gt; db.locations.find({
...   location: {
...     $geoWithin: {
...       $geometry: {
...         type: <span class="hljs-string">"Polygon"</span>,
...         coordinates: [[
...           [<span class="hljs-number">-109</span>, <span class="hljs-number">41</span>],
...           [<span class="hljs-number">-102</span>, <span class="hljs-number">41</span>],
...           [<span class="hljs-number">-102</span>, <span class="hljs-number">37</span>],
...           [<span class="hljs-number">-109</span>, <span class="hljs-number">37</span>],
...           [<span class="hljs-number">-109</span>, <span class="hljs-number">41</span>]
...         ]]
...       }
...     }
...   }
... })
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159d94067070bfcb01295"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Aspen"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-106.82</span>, <span class="hljs-number">39.18</span> ] } }</code></pre><p>The <code>$geoWithin</code> operator and the <code>$geoIntersects</code> operator have 2 key
differences:</p>
<ul>
<li><code>$geoWithin</code> searches for geometries that are contained entirely within a given geometry, whereas <code>$geoIntersects</code> looks for geometries that intersect. If the property you&#39;re searching for contains points, these are the same, but the results may differ if your documents contain polygons. More on this later.</li>
<li><code>$geoWithin</code> supports several shape operators in addition to <code>$geometry</code>, including <code>$centerSphere</code>, which is the right way to do a &quot;find all documents within 300 miles of San Francisco&quot; query.</li>
</ul>
<p>It&#39;s tricky to visualize a circle of radius 300 miles with a GeoJSON visualizer,
but here&#39;s how the ski resorts look with a square of <a href="http://mathworld.wolfram.com/Circumradius.html">circumradius</a> 300 miles centered on San Francisco (approximately latitude 37.7, longitude -122.5):</p>
<a href="http://bl.ocks.org/anonymous/raw/5e33ac4eb082b1c37684319905e26566/">
    <img src="http://i.imgur.com/7Oanv3z.jpg" />
</a>

<p>So the expected result is 2 documents, Mammoth Lakes and Squaw Valley.
Here&#39;s how the MongoDB query with <code>$geoWithin</code> and <code>$centerSphere</code> looks:</p>
<pre><code>&gt; db.locations.find({
...   location: {
...     $geoWithin: {
...       $centerSphere: [[<span class="hljs-number">-122.5</span>, <span class="hljs-number">37.7</span>], <span class="hljs-number">300</span> / <span class="hljs-number">3963.2</span>]
...     }
...   }
... })
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"5801594c4067070bfcb01293"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Squaw Valley"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-120.24</span>, <span class="hljs-number">39.21</span> ] } }
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159634067070bfcb01294"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Mammoth Lakes"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-118.9</span>, <span class="hljs-number">37.61</span> ] } }
&gt;</code></pre><p>What&#39;s with the crazy 3963.2 magic number? <code>$centerSphere</code> takes the distance
in radians, so you need to divide by the radius of the Earth, which is
about <a href="https://en.wikipedia.org/wiki/Earth_radius#Fixed_radius">3963.2 miles at the equator</a>. This estimate
is usually good enough because the Earth&#39;s radius <a href="https://en.wikipedia.org/wiki/Earth_radius#Notable_geocentric_radii">only has a range of about 20 miles</a>.</p>
<h2 id="how-do-i-sort-documents-by-distance-from-a-given-point">How do I sort documents by distance from a given point?</h2>
<p>The <code>$geoWithin</code> query above gives you all documents within 300 miles of San
Francisco, but those documents can be in any order. Let&#39;s say you wanted to
find all documents within 900 miles of San Francisco and order then by distance.
Using Node.js and the <a href="https://www.npmjs.com/package/turf">turf</a> module, you&#39;ll see that Whistler is just over 900
miles away from the point we&#39;ve chosen to represent San Francisco, and Aspen
is just under 900 miles away:</p>
<pre><code>$ node
&gt; <span class="hljs-keyword">var</span> turf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'turf'</span>)
<span class="hljs-literal">undefined</span>
&gt; turf.distance(turf.point([<span class="hljs-number">-122.5</span>, <span class="hljs-number">37.1</span>]), turf.point([<span class="hljs-number">-106.82</span>, <span class="hljs-number">39.18</span>]), <span class="hljs-string">'miles'</span>)
<span class="hljs-number">863.2551069982414</span>
&gt; turf.distance(turf.point([<span class="hljs-number">-122.5</span>, <span class="hljs-number">37.1</span>]), turf.point([<span class="hljs-number">-122.95</span>, <span class="hljs-number">50.12</span>]), <span class="hljs-string">'miles'</span>)
<span class="hljs-number">900.1549979044975</span>
&gt;</code></pre><p>The way to run this query in MongoDB is the
<a href="https://docs.mongodb.com/manual/reference/operator/query/nearSphere/"><code>$nearSphere</code> operator</a>.
The <code>$nearSphere</code> operator requires you to create a <a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere index</a>. Here&#39;s how that looks
in the MongoDB shell:</p>
<pre><code>&gt; db.locations.ensureIndex({ location: <span class="hljs-string">'2dsphere'</span> })
{
    <span class="hljs-string">"createdCollectionAutomatically"</span> : <span class="hljs-literal">false</span>,
    <span class="hljs-string">"numIndexesBefore"</span> : <span class="hljs-number">1</span>,
    <span class="hljs-string">"numIndexesAfter"</span> : <span class="hljs-number">2</span>,
    <span class="hljs-string">"ok"</span> : <span class="hljs-number">1</span>
}</code></pre><p>The <code>$nearSphere</code> operator takes a <code>$geometry</code> property that&#39;s a GeoJSON point, and <code>$minDistance</code> and <code>$maxDistance</code> properties that are in <strong>meters</strong>.</p>
<pre><code>&gt; db.locations.find({
...   location: {
...     $nearSphere: {
...       $geometry: {
...         type: <span class="hljs-string">'Point'</span>,
...         coordinates: [<span class="hljs-number">-122.5</span>, <span class="hljs-number">37.1</span>]
...       },
...       $maxDistance: <span class="hljs-number">900</span> * <span class="hljs-number">1609.34</span>
...     }
...   }
... })
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"5801594c4067070bfcb01293"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Squaw Valley"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-120.24</span>, <span class="hljs-number">39.21</span> ] } }
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159634067070bfcb01294"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Mammoth Lakes"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-118.9</span>, <span class="hljs-number">37.61</span> ] } }
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159d94067070bfcb01295"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Aspen"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-106.82</span>, <span class="hljs-number">39.18</span> ] } }
&gt;</code></pre><p>The 1609.34 multiplier converts from <a href="http://www.metric-conversions.org/length/miles-to-meters-table.htm">miles to meters</a>.
You can also specify <code>$minDistance</code>.</p>
<p>What if, in addition to sorting by distance, you want MongoDB to compute the
actual distance for you too? The <a href="https://docs.mongodb.com/manual/aggregation/">MongoDB aggregation framework</a> has a <a href="https://docs.mongodb.com/v3.0/reference/operator/aggregation/geoNear/"><code>$geoNear</code> stage</a> which behaves pretty similarly to <code>$nearSphere</code>. The difference between <code>$nearSphere</code> and <code>$geoNear</code> is a common source of confusion. Usually, if you
want to execute a query you use <code>$nearSphere</code>, and if you want to use the
aggregation framework, you need to use <code>$geoNear</code>.</p>
<p><code>$geoNear</code> is an aggregation framework stage that takes in several properties:</p>
<ul>
<li><code>near</code>, which is the GeoJSON point</li>
<li><code>spherical</code>, which must be true if you&#39;re using a 2dsphere index (and you should use a 2dsphere index rather than a 2d index unless you have a good reason)</li>
<li><code>maxDistance</code> and <code>minDistance</code>, in meters</li>
<li><code>distanceField</code> and <code>distanceMultiplier</code>, which are the field to put the computed distance in and the factor to multiply it by.</li>
</ul>
<p>Here&#39;s the &quot;order ski locations within 900 miles of San Francisco by distance and print the computed distance&quot; query. Note that <code>maxDistance</code> is in meters, so
we need to multiply 900 by 1609.34, and then divide again by 1609.34 so the
computed <code>distanceFromSF</code> is in miles.</p>
<pre><code>&gt; db.locations.aggregate([{
...   $geoNear: {
...     near: {
...       type: <span class="hljs-string">'Point'</span>,
...       coordinates: [<span class="hljs-number">-122.5</span>, <span class="hljs-number">37.1</span>]
...     },
...     spherical: <span class="hljs-literal">true</span>,
...     maxDistance: <span class="hljs-number">900</span> * <span class="hljs-number">1609.34</span>,
...     distanceMultiplier: <span class="hljs-number">1</span> / <span class="hljs-number">1609.34</span>,
...     distanceField: <span class="hljs-string">'distanceFromSF'</span>
...   }
... }])
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"5801594c4067070bfcb01293"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Squaw Valley"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-120.24</span>, <span class="hljs-number">39.21</span> ] }, <span class="hljs-string">"distanceFromSF"</span> : <span class="hljs-number">190.80440056422898</span> }
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159634067070bfcb01294"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Mammoth Lakes"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-118.9</span>, <span class="hljs-number">37.61</span> ] }, <span class="hljs-string">"distanceFromSF"</span> : <span class="hljs-number">201.0443259531628</span> }
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"580159d94067070bfcb01295"</span>), <span class="hljs-string">"name"</span> : <span class="hljs-string">"Aspen"</span>, <span class="hljs-string">"location"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Point"</span>, <span class="hljs-string">"coordinates"</span> : [ <span class="hljs-number">-106.82</span>, <span class="hljs-number">39.18</span> ] }, <span class="hljs-string">"distanceFromSF"</span> : <span class="hljs-number">863.9477714789235</span> }</code></pre><p><strong>Protip:</strong> Always test your queries carefully, don&#39;t just define a big polygon
and check if your geospatial query returns all documents. I&#39;ve been using
geospatial queries for years and I still forget which units the various
geospatial operators use in which versions of MongoDB. This data set would make
a good test case, because Whistler is slightly more than 900 miles away and
Aspen is slightly less. A good test case would take in 900 and assert that
Aspen is in the results and Whistler is not.</p>
<h2 id="which-polygons-are-within-x-miles-of-a-given-point">Which polygons are within X miles of a given point?</h2>
<p>MongoDB geospatial operators work with 2 GeoJSON types: points and polygons.
Note that MongoDB geospatial operators do <strong>not</strong> work with GeoJSON features
or feature collections. To stick with our current data set, let&#39;s create a
&#39;states&#39; collection that contains the minimal polygon for Colorado:</p>
<pre><code>&gt; db.states.find().pretty()
{
    <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"5801739adefd3a67cca15eae"</span>),
    <span class="hljs-string">"geometry"</span> : {
        <span class="hljs-string">"type"</span> : <span class="hljs-string">"Polygon"</span>,
        <span class="hljs-string">"coordinates"</span> : [
            [
                [
                    <span class="hljs-number">-109</span>,
                    <span class="hljs-number">41</span>
                ],
                [
                    <span class="hljs-number">-102</span>,
                    <span class="hljs-number">41</span>
                ],
                [
                    <span class="hljs-number">-102</span>,
                    <span class="hljs-number">37</span>
                ],
                [
                    <span class="hljs-number">-109</span>,
                    <span class="hljs-number">37</span>
                ],
                [
                    <span class="hljs-number">-109</span>,
                    <span class="hljs-number">41</span>
                ]
            ]
        ]
    }
}
&gt;</code></pre><p>We know that the entirety of Colorado is not within 900 miles of San Francisco,
but part of it is. To find all polygons that intersect with a 900 mile circle
centered at San Francisco, you need to use the <code>$nearSphere</code> operator
(which, remember, requires a &#39;2dsphere&#39; index).</p>
<pre><code>&gt; db.states.find({
...   geometry: {
...     $nearSphere: {
...       $geometry: {
...         type: <span class="hljs-string">'Point'</span>,
...         coordinates: [<span class="hljs-number">-122.5</span>, <span class="hljs-number">37.1</span>]
...       },
...       $maxDistance: <span class="hljs-number">900</span> * <span class="hljs-number">1609.34</span>
...     }
...   }
... })
{ <span class="hljs-string">"_id"</span> : ObjectId(<span class="hljs-string">"5801739adefd3a67cca15eae"</span>), <span class="hljs-string">"geometry"</span> : { <span class="hljs-string">"type"</span> : <span class="hljs-string">"Polygon"</span>, <span class="hljs-string">"coordinates"</span> : [ [ [ <span class="hljs-number">-109</span>, <span class="hljs-number">41</span> ], [ <span class="hljs-number">-102</span>, <span class="hljs-number">41</span> ], [ <span class="hljs-number">-102</span>, <span class="hljs-number">37</span> ], [ <span class="hljs-number">-109</span>, <span class="hljs-number">37</span> ], [ <span class="hljs-number">-109</span>, <span class="hljs-number">41</span> ] ] ] } }
&gt;</code></pre><p>To double check, try running the query with 500 miles and see that you get
no results:</p>
<pre><code>&gt; db.states.find({
...   geometry: {
...     $nearSphere: {
...       $geometry: {
...         type: <span class="hljs-string">'Point'</span>,
...         coordinates: [<span class="hljs-number">-122.5</span>, <span class="hljs-number">37.1</span>]
...       },
...       $maxDistance: <span class="hljs-number">500</span> * <span class="hljs-number">1609.34</span>
...     }
...   }
... })
&gt;</code></pre><h2 id="side-note-on-self-intersecting-polygons">Side Note on Self-Intersecting Polygons</h2>
<p><a href="https://jira.mongodb.org/browse/SERVER-20672">MongoDB does <strong>not</strong> support self-intersecting polygons</a>. You can store these
in MongoDB but geospatial query operators can&#39;t search through them and your
2dsphere index builds will fail if you have self-intersecting polygons in
your collection. These are surprisingly
common in <a href="https://www.google.com/maps/place/Fred,+TX+77616/@30.5530819,-94.2834776,14.5z/data=!4m5!3m4!1s0x863910db5b73e1d7:0xd21eaba7f50af4d2!8m2!3d30.585557!4d-94.2435893">US zip code data</a>, so make sure you <a href="https://www.npmjs.com/package/turf-kinks">sanitize your data</a> first.</p>
<h2 id="moving-on">Moving On</h2>
<p>MongoDB geospatial queries let you solve many common geo-related tasks with
no extra tools or plugins. At <a href="https://www.boosterfuels.com/join-the-team">Booster</a>, we briefly considered various geocoding
API&#39;s before finding their rate limits too stringent and their reliability
wanting, and just ended up importing state and zip code polygons into MongoDB.
If geospatial is as core a part of your business as it is for us, MongoDB&#39;s the
only way to go.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"/></body></html>