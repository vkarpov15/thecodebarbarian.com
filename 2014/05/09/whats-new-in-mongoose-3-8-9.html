<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TE4SWRGR9E"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'G-TE4SWRGR9E');
</script><title>What's New in Mongoose 3.8.9 | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="What's New in Mongoose 3.8.9"><meta property="og:url" content="http://www.thecodebarbarian.com/2014/05/09/whats-new-in-mongoose-3-8-9"><meta property="og:image" content="//houstonbeerweek.com/cal/uploads/mvsc.jpg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="I have an important announcement to make: over the last couple weeks I've been taking over maintaining [mongoose](http://mongoosejs.com/), the popular MongoDB/NodeJS ODM. I have some very big shoes to fill, [Aaron Heckmann](https://twitter.com/aaronheckmann) has done an extraordinary job building mongoose into an indispensable part of the NodeJS ecosystem. As an avid user of mongoose over the last two years, I look forward to continuing mongoose's storied tradition of making dealing with data elegant and fun. However, mongoose isn't perfect, and I'm already looking forward to the next major stable release, 4.0.0. Suggestions are most welcome, but please be patient, I'm still trying to catch up on the backlog of issues and pull requests."><meta name="twitter:image" content="//houstonbeerweek.com/cal/uploads/mvsc.jpg"><meta name="twitter:card" content="summary_large_image"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">What's New in Mongoose 3.8.9</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">May 09, 2014</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p>I have an important announcement to make: over the last couple weeks I&#39;ve been taking over maintaining <a href="http://mongoosejs.com/">mongoose</a>, the popular MongoDB/NodeJS ODM. I have some very big shoes to fill, <a href="https://twitter.com/aaronheckmann">Aaron Heckmann</a> has done an extraordinary job building mongoose into an indispensable part of the NodeJS ecosystem. As an avid user of mongoose over the last two years, I look forward to continuing mongoose&#39;s storied tradition of making dealing with data elegant and fun. However, mongoose isn&#39;t perfect, and I&#39;m already looking forward to the next major stable release, 4.0.0. Suggestions are most welcome, but please be patient, I&#39;m still trying to catch up on the backlog of issues and pull requests.</p>
<h2 id="on-to-whats-new-in-389">On to what&#39;s new in 3.8.9</h2>
<p>On that note, Mongoose 3.8.9 was (finally) released yesterday. This was primarily a maintenance release, the major priority was to clean up several test failures against the new stable version of the MongoDB server, 2.6.x, without any backward-breaking API changes. I&#39;m proud to say that 3.8.9 should be compatible with MongoDB 2.2.x, 2.4.x, and 2.6.x. In addition, I added improved support for a couple of key MongoDB 2.6 features:</p>
<h3 id="support-for-text-search-in-mongodb-26x">Support for Text Search in MongoDB 2.6.x</h3>
<p>As I mentioned in my post on <a href="http://thecodebarbarian.com/2014/04/10/a-nodejs-perspective-on-whats-new-in-mongodb-2-6-part-i-text-search/">text search</a>, mongoose 3.8.8 didn&#39;t quite support text search yet: mongoose prevented you from sorting by text score. <a href="https://github.com/aheckmann/mquery/commit/86a054aef1eec3701359e18bfcf24d12a320cace">This commit</a>, which went into mquery 0.6.0, allows you to use the new <a href="http://docs.mongodb.org/manual/reference/operator/projection/meta/"><code>$meta</code> operator</a> in <code>sort()</code> calls. Here&#39;s an example of how you would use text search with sorting in mongoose:</p>
<pre><code>/* Blog post collection with two documents:
 * { title : &#39;text search in mongoose&#39; }
 * { title : &#39;searching in mongoose&#39; }
 * and a text index on the &#39;title&#39; field */
BlogPost.
  find(
    { $text : { $search : &#39;text search&#39; } },
    { score : { $meta: &quot;textScore&quot; } }
  ).
  sort({ score : { $meta : &#39;textScore&#39; } }).
  limit(2).
  exec(function(error, documents) {
    assert.ifError(error);
    assert.equal(2, documents.length);
    assert.equal(&#39;text search in mongoose&#39;, documents[0].title);
    assert.equal(&#39;searching in mongoose&#39;, documents[1].title);
    db.close();
    done();
  });</code></pre><p>The relevant test case can be found <a href="https://github.com/LearnBoost/mongoose/blob/4a812b535382527b771e85c4cf2cc72eab2814ff/test/model.querying.test.js#L1567-1589">here</a> (there&#39;s also <a href="https://github.com/LearnBoost/mongoose/blob/4a812b535382527b771e85c4cf2cc72eab2814ff/test/model.querying.test.js#L1452-1478">test coverage</a> for text search without sorting). Please note that you&#39;re responsible for making sure you&#39;re running &gt;= MongoDB 2.6.0, running text queries against older versions of MongoDB will not give you the expected behavior. MongoDB&#39;s docs about text search can be found <a href="http://docs.mongodb.org/manual/core/index-text/">here</a>.</p>
<h3 id="aggregation-helper-for-out">Aggregation helper for <code>$out</code>:</h3>
<p>As I mentioned in <a href="http://thecodebarbarian.com/2014/04/25/a-nodejs-perspective-on-whats-new-in-mongodb-2-6-part-ii-aggregation-out/">my post</a> about the aggregation framework&#39;s <code>$out</code> pipeline stage (which pipes the aggregation output to a collection), mongoose&#39;s aggregate() function doesn&#39;t prevent you from using <code>$out</code>. However, mongoose also supports syntactic sugar for chaining helper functions onto <code>aggregate()</code> for building an aggregation pipeline:</p>
<pre><code>MyModel.aggregate()
  .group(group.$group)
  .project(project.$project)
  .exec(function (err, res) {
  });</code></pre><p><a href="https://github.com/LearnBoost/mongoose/commit/c228c734e899f7f82a944e7cee545bf47c5cab6e">This commit</a> adds a <code>.out()</code> helper function that you can use to add a <code>$out</code> stage to your pipeline. Note that you&#39;re responsible for making sure that the <code>.out()</code> function is the last stage of your pipeline, because the MongoDB server will return an error if it isn&#39;t. The relevant test case can be found here. Here&#39;s how the new helper function looks in action:</p>
<pre><code>var outputCollection = &#39;my_output_collection&#39;;

MyModel.aggregate()
  .group(group.$group)
  .project(project.$project)
  .out(outputCollection)
  .exec(function(error, result) {
  });</code></pre><h3 id="a-minor-caveat-for-26x-compatibility">A Minor Caveat For 2.6.x Compatibility</h3>
<p>There is still one unfortunate edge case remaining in 3.8.9 which only affects MongoDB 2.6.x. MongoDB 2.6.x unfortunately no longer allows <a href="https://jira.mongodb.org/browse/SERVER-12266">empty <code>$set</code> operators</a> to be passed to <code>update()</code> and <code>findAndModify()</code>. This change only affects mongoose in the case where you set the <code>upsert</code> flag to true. <a href="https://github.com/LearnBoost/mongoose/commit/c1efafb2b05bf3ed455ad6ce9631d69240c76498">This commit</a> attempts to mitigate this API inconsistency, but there is still one case where you will get an error on MongoDB 2.6.x but not in 2.4.x: if the query passed to your <code>findAndModify()</code> only includes an <code>_id</code> field. For example,</p>
<pre><code>MyModel.findOneAndUpdate(
  { _id: &#39;MY_ID&#39; },
  {},
  { upsert: true },
  function(error, document) {
  });</code></pre><p>Will return a server error on MongoDB 2.6.1 but not 2.4.10. Right now, there is no good way to handle this case in both 2.4 and 2.6 without either doing an if-statement on the version or breaking the existing API. You can track the progress of this issue on <a href="https://github.com/LearnBoost/mongoose/issues/2065">Github</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Hope y&#39;all are as excited about mongoose&#39;s future as I am. There&#39;s lots of exciting ideas that I&#39;m looking forward to getting into mongoose 4.0. You&#39;re more than welcome to add suggestions for new features or behavior changes on <a href="https://github.com/LearnBoost/mongoose/issues">Github issues</a>. I&#39;m looking forward to seeing what y&#39;all can come up with for improving mongoose and what y&#39;all will be able to do with future versions.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>