<html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>A Node.js Perspective on MongoDB 4.0: Transactions | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"/><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/><link href="/style/style.css" rel="stylesheet" type="text/css"/><link href="/style/github.css" rel="stylesheet" type="text/css"/><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="A Node.js Perspective on MongoDB 4.0: Transactions"/><meta property="og:url" content="http://www.thecodebarbarian.com/a-node-js-perspective-on-mongodb-4-transactions"/><meta property="og:image" content="https://i.imgur.com/RrTiade.png"/><meta property="og:site_name" content="The Code Barbarian"/></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li></ul></div></div><div id="nav" class="navbar"><div class="container"><div class="navbar-header"><a href="http://thecodebarbarian.com" class="navbar-brand big-brand"><img src="/images/Barbarian_Head.png" class="logo"/><span class="site-name">The Code Barbarian</span></a></div><div id="home-nav-mobile" class="navbar-right collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/angularjs.html">AngularJS</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div id="desktop-right-bar" class="col-lg-3 col-lg-offset-9 right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net"><img src="http://asyncawait.net/images/cover_400.png"/><p><i>Mastering Async/Await</i></p></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"/><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div><div><script type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=thecodebarbariancom" id="_carbonads_js"></script></div></p></div></div></div></div></div><div id="mobile-sharing-options" class="container-fluid hidden-sm hidden-md hidden-lg"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Fa-node-js-perspective-on-mongodb-4-transactions&amp;via=code_barbarian" class="social"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fa-node-js-perspective-on-mongodb-4-transactions" class="social"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fa-node-js-perspective-on-mongodb-4-transactions" class="social"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a href="#disqus_thread" class="social"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div id="desktop-sharing-options" class="post-sharing-options hidden-xs pull-left"><ul class="list-unstyled"><li class="twitter-share"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Fa-node-js-perspective-on-mongodb-4-transactions&amp;via=code_barbarian" class="social"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fa-node-js-perspective-on-mongodb-4-transactions" class="social"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Fa-node-js-perspective-on-mongodb-4-transactions" class="social"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">A Node.js Perspective on MongoDB 4.0: Transactions</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">July 02, 2018</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script>
  _native.init("CK7DT53N",{
    targetClass: 'native-inline'
  });
</script>

<div class="native-inline">
  <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# - #native_desc#</a>
</div>
</div><div class="post-body-text-container"><p><a href="https://www.mongodb.com/transactions">Transactions</a> are undoubtedly the most
important new feature in <a href="https://www.mongodb.com/mongodb-4.0">MongoDB 4.0</a>.
MongoDB has supported <a href="https://docs.mongodb.com/manual/core/write-operations-atomicity/">ACID for single document operations</a> for many years, and <a href="http://thecodebarbarian.com/managing-embedded-documents-with-monogram">denormalized data</a> meant many apps didn&#39;t need transactions. However, for certain applications,
there&#39;s no way to escape the need for multi-document transactions. In this
article, I&#39;ll demonstrate using transactions with the <a href="http://npmjs.com/package/mongodb">MongoDB Node.js driver</a> and <a href="https://www.npmjs.com/package/mongoose">mongoose</a>.</p>
<h2 id="transferring-money-between-accounts-in-node-js">Transferring Money Between Accounts in Node.js</h2>
<p><a href="https://docs.mongodb.com/manual/replication/#transactions">MongoDB currently only supports transactions on replica sets</a>, not standalone servers. To run a <a href="/introducing-run-rs-zero-config-mongodb-runner.html">local replica set for development</a> on OSX or Linux, use npm to install <a href="https://www.npmjs.com/package/run-rs">run-rs</a> globally and run <code>run-rs --version 4.0.0</code>. Run-rs will download MongoDB 4.0.0 for you.</p>
<pre><code>$ npm install run-rs -g
$ run-rs --version <span class="hljs-number">4.0</span><span class="hljs-number">.0</span>
Purging database...
Running <span class="hljs-string">'/home/node/lib/node_modules/run-rs/4.0.0/mongod'</span>
Starting replica set...
Started replica set on <span class="hljs-string">"mongodb://localhost:27017,localhost:27018,localhost:27019"</span>
Connected to oplog
</code></pre><p>Once you have a MongoDB 4.0.0 replica set running, you&#39;ll also need <a href="https://www.npmjs.com/package/mongodb">v3.1.0 of the MongoDB Node.js driver</a>.</p>
<pre><code>npm install mongodb@<span class="hljs-number">3.1</span>
</code></pre><p>One example of an app that needs multi-document transactions is a bank account
app. If you transfer money from account <code>A</code> to account <code>B</code>, nobody should see an
in-between state where money has been deducted from account <code>A</code> but hasn&#39;t
been added to account <code>B</code>. And, if subtracting money from account <code>A</code> fails due
to insufficient funds, you shouldn&#39;t add money to account <code>B</code>.</p>
<p>In MongoDB, transactions are built on top of <a href="https://docs.mongodb.com/manual/reference/server-sessions/">sessions</a>. To
start a transaction, you first need to start a session using <code>client.startSession()</code>. You can then call the session&#39;s <code>startTransaction()</code>
method to start a transaction.</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Boilerplate: connect to DB</span>
<span class="hljs-keyword">const</span> { MongoClient } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);
<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'mongodb://localhost:27017,localhost:27018,localhost:27019/txn'</span>;
<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">await</span> MongoClient.connect(uri, { useNewUrlParser: <span class="hljs-literal">true</span>, replicaSet: <span class="hljs-string">'rs'</span> });

<span class="hljs-keyword">const</span> db = client.db();
<span class="hljs-keyword">await</span> db.dropDatabase();

<span class="hljs-comment">// Insert accounts and transfer some money</span>
<span class="hljs-keyword">await</span> db.collection(<span class="hljs-string">'Account'</span>).insertMany([
  { name: <span class="hljs-string">'A'</span>, balance: <span class="hljs-number">5</span> },
  { name: <span class="hljs-string">'B'</span>, balance: <span class="hljs-number">10</span> }
]);

<span class="hljs-keyword">await</span> transfer(<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// Success</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// Fails because then A would have a negative balance</span>
  <span class="hljs-keyword">await</span> transfer(<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-number">2</span>);
} <span class="hljs-keyword">catch</span> (error) {
  error.message; <span class="hljs-comment">// "Insufficient funds: 1"</span>
}

<span class="hljs-comment">// The actual transfer logic</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transfer</span>(<span class="hljs-params">from, to, amount</span>) </span>{
  <span class="hljs-keyword">const</span> session = client.startSession();
  session.startTransaction();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> opts = { session, returnOriginal: <span class="hljs-literal">false</span> };
    <span class="hljs-keyword">const</span> A = <span class="hljs-keyword">await</span> db.collection(<span class="hljs-string">'Account'</span>).
      findOneAndUpdate({ name: <span class="hljs-keyword">from</span> }, { $inc: { balance: -amount } }, opts).
      then(res =&gt; res.value);
    <span class="hljs-keyword">if</span> (A.balance &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// If A would have negative balance, fail and abort the transaction</span>
      <span class="hljs-comment">// `session.abortTransaction()` will undo the above `findOneAndUpdate()`</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Insufficient funds: '</span> + (A.balance + amount));
    }

    <span class="hljs-keyword">const</span> B = <span class="hljs-keyword">await</span> db.collection(<span class="hljs-string">'Account'</span>).
      findOneAndUpdate({ name: to }, { $inc: { balance: amount } }, opts).
      then(res =&gt; res.value);

    <span class="hljs-keyword">await</span> session.commitTransaction();
    session.endSession();
    <span class="hljs-keyword">return</span> { <span class="hljs-keyword">from</span>: A, to: B };
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// If an error occurred, abort the whole transaction and</span>
    <span class="hljs-comment">// undo any changes that might have happened</span>
    <span class="hljs-keyword">await</span> session.abortTransaction();
    session.endSession();
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// Rethrow so calling function sees error</span>
  }
}
</code></pre>
<h2 id="transactions-with-mongoose">Transactions with Mongoose</h2>
<p>To use transactions with <a href="http://mongoosejs.com/">Mongoose</a>, you need <code>mongoose &gt;= 5.2.0</code>.</p>
<pre><code>npm install mongoose@<span class="hljs-number">5.2</span>
</code></pre><p>Transactions with Mongoose are similar to with the MongoDB driver. The big
difference is that, with Mongoose, <a href="http://mongoosejs.com/docs/api.html#startsession_startSession"><code>startSession()</code> returns a promise rather than a session</a>,
so you need to use <code>await</code>.</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Boilerplate: connect to DB</span>
<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'mongodb://localhost:27017,localhost:27018,localhost:27019/txn'</span>;
<span class="hljs-keyword">await</span> mongoose.connect(uri, { replicaSet: <span class="hljs-string">'rs'</span> });

<span class="hljs-keyword">await</span> mongoose.connection.dropDatabase();
<span class="hljs-keyword">const</span> Account = mongoose.model(<span class="hljs-string">'Account'</span>, <span class="hljs-keyword">new</span> mongoose.Schema({
  name: <span class="hljs-built_in">String</span>, balance: <span class="hljs-built_in">Number</span>
}));

<span class="hljs-comment">// Insert accounts and transfer some money</span>
<span class="hljs-keyword">await</span> Account.create([{ name: <span class="hljs-string">'A'</span>, balance: <span class="hljs-number">5</span> }, { name: <span class="hljs-string">'B'</span>, balance: <span class="hljs-number">10</span> }]);

<span class="hljs-keyword">await</span> transfer(<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// Success</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// Fails because then A would have a negative balance</span>
  <span class="hljs-keyword">await</span> transfer(<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-number">2</span>);
} <span class="hljs-keyword">catch</span> (error) {
  error.message; <span class="hljs-comment">// "Insufficient funds: 1"</span>
}

<span class="hljs-comment">// The actual transfer logic</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transfer</span>(<span class="hljs-params">from, to, amount</span>) </span>{
  <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> mongoose.startSession();
  session.startTransaction();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> opts = { session, <span class="hljs-keyword">new</span>: <span class="hljs-literal">true</span> };
    <span class="hljs-keyword">const</span> A = <span class="hljs-keyword">await</span> Account.
      findOneAndUpdate({ name: <span class="hljs-keyword">from</span> }, { $inc: { balance: -amount } }, opts);
    <span class="hljs-keyword">if</span> (A.balance &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// If A would have negative balance, fail and abort the transaction</span>
      <span class="hljs-comment">// `session.abortTransaction()` will undo the above `findOneAndUpdate()`</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Insufficient funds: '</span> + (A.balance + amount));
    }

    <span class="hljs-keyword">const</span> B = <span class="hljs-keyword">await</span> Account.
      findOneAndUpdate({ name: to }, { $inc: { balance: amount } }, opts);

    <span class="hljs-keyword">await</span> session.commitTransaction();
    session.endSession();
    <span class="hljs-keyword">return</span> { <span class="hljs-keyword">from</span>: A, to: B };
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// If an error occurred, abort the whole transaction and</span>
    <span class="hljs-comment">// undo any changes that might have happened</span>
    <span class="hljs-keyword">await</span> session.abortTransaction();
    session.endSession();
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// Rethrow so calling function sees error</span>
  }
}
</code></pre>
<p>With both Mongoose and the MongoDB Node.js driver, MongoDB will report a
&quot;WriteConflict&quot; error if two transactions attempt to write conflicting data,
like if two <code>transfer()</code> calls attempt to transfer money from the same account
at the same time.</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all([
    transfer(<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-number">4</span>),
    transfer(<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-number">2</span>)
  ]);
} <span class="hljs-keyword">catch</span> (error) {
  error.message; <span class="hljs-comment">// "MongoError: WriteConflict"</span>
}
</code></pre>
<h2 id="moving-on">Moving On</h2>
<p>Transactions are the most important feature to land in MongoDB in recent memory.
The ability to execute multiple operations in isolation and potentially undo
all of them is useful for any app, not just apps that need to transfer currency
between accounts. For example, you can update denormalized data in multiple
collections and easily undo all the operations using <code>abortTransaction()</code> if
<a href="https://docs.mongodb.com/manual/core/schema-validation/">schema validation</a> failed. So download <a href="https://www.npmjs.com/package/run-rs">run-rs</a>,
MongoDB driver 3.1.0, and Mongoose 5.2.0 and get started with transactions today!</p>
<p><em>Transactions are much better with <a href="http://thecodebarbarian.com/common-async-await-design-patterns-in-node.js.html">async/await in Node.js</a> so you can use <code>try/catch</code> rather than promise chaining.
If you&#39;re looking to get up to speed with async/await fast, check out
my new ebook, <a href="http://asyncawait.net/">Mastering Async/Await</a>.</em></p>
<p><a href="http://asyncawait.net"><img src="/images/asyncawait.png"/></a></p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/20180702_mongodb_transactions.md">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
  analytics.load("5DErrxzVhprg8sNh8xaiKDR6dNa7yGTI");
  analytics.page()
}}();</script><script type="text/javascript">analytics.track('opened post',
  { title: "A Node.js Perspective on MongoDB 4.0: Transactions", time: new Date() });
  </script><link rel="stylesheet" href="/style/inlinecpc.css"/></body></html>