<html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Offline Caching With Service Workers | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"/><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"/><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"/><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/><link href="/style/style.css" rel="stylesheet" type="text/css"/><link href="/style/github.css" rel="stylesheet" type="text/css"/><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Offline Caching With Service Workers"/><meta property="og:url" content="http://www.thecodebarbarian.com/offline-caching-with-service-workers"/><meta property="og:image" content="https://i.imgur.com/Il2PXsU.png"/><meta property="og:site_name" content="The Code Barbarian"/></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li></ul></div></div><div id="nav" class="navbar"><div class="container"><div class="navbar-header"><a href="http://thecodebarbarian.com" class="navbar-brand big-brand"><img src="/images/Barbarian_Head.png" class="logo"/><span class="site-name">The Code Barbarian</span></a></div><div id="home-nav-mobile" class="navbar-right collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/angularjs.html">AngularJS</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div id="desktop-right-bar" class="col-lg-3 col-lg-offset-9 right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"/></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"/><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div><div><script type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&amp;serve=C6AILKT&amp;placement=thecodebarbariancom" id="_carbonads_js"></script></div></p></div></div></div></div></div><div id="mobile-sharing-options" class="container-fluid hidden-sm hidden-md hidden-lg"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Foffline-caching-with-service-workers&amp;via=code_barbarian" class="social"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Foffline-caching-with-service-workers" class="social"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Foffline-caching-with-service-workers" class="social"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a href="#disqus_thread" class="social"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div id="desktop-sharing-options" class="post-sharing-options hidden-xs pull-left"><ul class="list-unstyled"><li class="twitter-share"><a href="https://twitter.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2Foffline-caching-with-service-workers&amp;via=code_barbarian" class="social"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Foffline-caching-with-service-workers" class="social"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a href="https://plus.google.com/share?url=http%3A%2F%2Fwww.thecodebarbarian.com%2F%2Foffline-caching-with-service-workers" class="social"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Offline Caching With Service Workers</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">July 27, 2018</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script>
  _native.init("CK7DT53N",{
    targetClass: 'native-inline'
  });
</script>

<div class="native-inline">
  <a href="#native_link#"><span class="sponsor">Sponsor</span> #native_company# - #native_desc#</a>
</div>
</div><div class="post-body-text-container"><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service workers</a> are a versatile API used for numerous exciting new browser features, from <a href="https://googlechrome.github.io/samples/service-worker/prefetch/">pre-fetching resources</a> to <a href="http://thecodebarbarian.com/sending-web-push-notifications-from-node-js">push notifications</a>. One interesting feature is the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache">Cache API</a>, which lets you store
assets on the client&#39;s machine and intercept requests for these assets to load
them from cache instead. Using the Cache API, you can make your site usable
when your user doesn&#39;t have internet access, as long as you cache the right assets.
In this article, I&#39;ll walk through creating a service worker that makes the <a href="http://mongoosejs.com/docs/guide.html">Mongoose schema docs</a>
available offline.</p>
<h2 id="setting-up">Setting Up</h2>
<p>First, <a href="https://s3.amazonaws.com/valeri-karpov-test/guide.html">here&#39;s a raw HTML version of the Mongoose schema docs</a> that has been
tweaked to use absolute paths so it appears normally in your browser when you
have internet access. Set up a static web server locally on port 5000 (I recommend <a href="https://www.npmjs.com/package/serve"><code>npm install serve@9.4.0</code></a> ), you should see the below
page when you visit <code>http://localhost:5000/guide</code>.</p>
<p><img class="inline-image" src="https://i.imgur.com/5EkX0h1.png"></p>
<p>The Mongoose docs site is lean relative to your average site, which is <a href="https://www.wired.com/2016/04/average-webpage-now-size-original-doom/">bigger than the original <em>Doom</em> video game</a>.
However, in order to render properly it still needs some fonts, CSS files, and
images. For the Mongoose docs, the JS files are non-essential, they just handle
ads and analytics.</p>
<p><img class="inline-image" src="https://i.imgur.com/dzYT9fX.png"></p>
<p>If you turn on the &quot;Offline&quot; checkbox in the Chrome Network tab, the page will
no longer render. With service workers, you can make this page render perfectly,
even in offline mode.</p>
<h2 id="creating-a-service-worker">Creating a Service Worker</h2>
<p>Service workers are scoped to a domain, so in this case you need to register
a service worker for <code>localhost:5000</code>. You can only register service workers
on what <a href="https://www.chromium.org/Home/chromium-security/prefer-secure-origins-for-powerful-new-features">Chrome considers &quot;secure domains&quot;</a>. For the benefit of developers, &#39;localhost&#39; is considered
secure, but any <code>http://</code> domain is not. To use service workers in production,
you <strong>must</strong> use HTTPS.</p>
<p>Let&#39;s create a <code>sw.js</code> file that prints out &quot;Hello, World!&quot; and put it in
the top level of the directory the static server uses, so you can access your service worker from <code>http://localhost:5000/sw.js</code>.</p>
<pre><code>$ curl http:<span class="hljs-comment">//localhost:5000/sw.js</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hello, World!'</span>);
$
</code></pre><p>Next, run <code>navigator.serviceWorker.register(&#39;./sw.js&#39;)</code> from your Chrome console.
You should see &quot;Hello, World!&quot; pop up.</p>
<p><img class="inline-image" src="https://i.imgur.com/iW5jxVe.png"></p>
<p>By itself, this service worker isn&#39;t interesting because it just prints a message
when it is registered and doesn&#39;t listen to any other events. For example, if
you reload the page, the <code>console.log()</code> won&#39;t execute again.</p>
<p>Service workers can intercept every outbound HTTP request from your page.
Change your <code>sw.js</code> file to the below to print out every single HTTP request
that the browser makes when rendering <code>guide.html</code>.</p>
<pre><code class="lang-javascript">self.addEventListener(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'fetch'</span>, event);
});
</code></pre>
<p><img class="inline-image" src="https://i.imgur.com/E0fyiI4.png"></p>
<p>The browser retains the service worker even in offline mode, so if you turn on
the &quot;Offline&quot; checkbox in Chrome&#39;s network tab you&#39;ll still see your service
worker intercept the HTTP request. Using this and the Cache API, you can
serve this page offline.</p>
<p><img class="inline-image" src="https://i.imgur.com/p22JQQd.png"></p>
<h2 id="caching-assets-in-the-service-worker">Caching Assets in the Service Worker</h2>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache/addAll"><code>Cache.addAll()</code> function</a> lets you pre-fetch a bunch of assets and store them in the cache. Combined with the
<a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith"><code>FetchEvent.respondWith()</code> function</a>, you can use promise chaining to <code>catch()</code> any network requests that fail and
check to see if the asset is cached locally. Google calls this caching strategy
<a href="https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/#network-falling-back-to-cache">&quot;Network falling back to cache&quot;</a>.</p>
<pre><code class="lang-javascript">self.addEventListener(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
  event.waitUntil(
    caches.open(<span class="hljs-string">'mycache'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cache</span>) </span>{
      <span class="hljs-keyword">return</span> cache.addAll([
        <span class="hljs-string">'http://localhost:5000/guide'</span>,
        <span class="hljs-string">'https://fonts.googleapis.com/css?family=Open+Sans'</span>,
        <span class="hljs-string">'http://mongoosejs.com/docs/css/github.css'</span>,
        <span class="hljs-string">'http://mongoosejs.com/docs/css/mongoose5.css'</span>,
        <span class="hljs-string">'https://unpkg.com/purecss@1.0.0/build/pure-min.css'</span>,
        <span class="hljs-string">'http://mongoosejs.com/docs/images/mongoose5_62x30_transparent.png'</span>
      ]);
    })
  );
});

self.addEventListener(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'fetch'</span>, event);

  <span class="hljs-keyword">return</span> event.respondWith(
    fetch(event.request).catch(() =&gt; caches.match(event.request.url))
  );
});
</code></pre>
<p>With this new service worker, you should see the Mongoose schema docs show up
even in offline mode. If the <a href="https://developers.google.com/web/fundamentals/primers/service-workers/#update-a-service-worker">service worker doesn&#39;t update automatically</a>, you may need to force an update using <code>navigator.serviceWorker.getRegistration().then(reg =&gt; reg.update())</code>.</p>
<p><img class="inline-image" src="https://i.imgur.com/RD450C6.png"></p>
<h2 id="moving-on">Moving On</h2>
<p>Ever start a project on an airplane and realize that you desperately
need access to docs? Service workers promise to make it much easier to access
documentation that you rely on when internet is spotty or non-existent.
If you maintain a documentation site, consider using service workers to let
your users easily access your site offline.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/20180727_service_worker_caching.md">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
  analytics.load("5DErrxzVhprg8sNh8xaiKDR6dNa7yGTI");
  analytics.page()
}}();</script><script type="text/javascript">analytics.track('opened post',
  { title: "Offline Caching With Service Workers", time: new Date() });
  </script><link rel="stylesheet" href="/style/inlinecpc.css"/></body></html>